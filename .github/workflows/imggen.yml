name: Compile Jar and generate image from scene

on:
  workflow_dispatch:
    inputs:
      scene_file_path:
        description: 'Path (relative to the repo root) or URL of the .scene file'
        required: true
        type: string

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build the JAR with Maven
        run: mvn -B package --file raytracer/pom.xml

      - name: Fetch .scene file if it is a URL
        if: startsWith(inputs.scene_file_path, 'http')
        run: |
          curl -LsS "${{ github.event.inputs.scene_file_path }}" -o input.scene

      - name: Copy .scene from repo if needed
        if: "!startsWith(inputs.scene_file_path, 'http')"
        run: |
          cp "${{ github.event.inputs.scene_file_path }}" input.scene

      - name: Run the raytracer jar with input scene
        run: |
          JAR_PATH=$(find raytracer/target -name "*.jar" | grep -v "original" | head -n1)
          java -jar "$JAR_PATH" input.scene

      - name: List generated PNG files
        run: ls -l *.png || echo "No PNGs found"

      - name: Upload output image(s)
        uses: actions/upload-artifact@v4
        with:
          name: rendered-images
          path: ./*.png
          if-no-files-found: warn
